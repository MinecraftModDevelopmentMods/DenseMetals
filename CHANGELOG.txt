Massive cleanups and codebase rewrite
